<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,width=device-width" />
  <title>Display Features with Connections</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.25/"></script>
  <style>
    html,
    body,
    #viewDiv {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .esri-component.esri-legend.esri-widget.esri-widget--panel {
      max-height: 15em;
    }
  </style>
</head>

<body>
  <div id="viewDiv"></div>
  <script>
    require([
      "esri/Map",
      "esri/WebMap",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/Graphic", "esri/layers/GraphicsLayer",
      "esri/geometry/Polyline", "esri/layers/GeoJSONLayer",
      "esri/geometry/geometryEngine", "esri/config", "esri/widgets/Home", "esri/core/reactiveUtils", "esri/widgets/Legend"
    ], function (Map, WebMap, MapView, FeatureLayer, Graphic, GraphicsLayer, Polyline, GeoJSONLayer, geometryEngine, esriConfig,
      Home, reactiveUtils, Legend) {



      esriConfig.portalUrl = "https://gisapps.scimar.com/arcgis"
      // Create the map
      const map = new WebMap({
        portalItem: { // autocasts as new PortalItem()
          id: "31a95cb114c449cbbc5616c415305c38"
        }
      });
      // Create the view
      var view = new MapView({
        container: "viewDiv",
        map: map
      });

      var windFarmLayer;
      let nodesGL = new GraphicsLayer({
        id: 'nodesGL',
        title: 'Nodes Layer'
      });
      let edgesGL = new GraphicsLayer({
        id: 'edgesGL',
        title: 'Edges Layer'
      });
      map.addMany([edgesGL, nodesGL]);
      view.when((event) => {
        // reactiveUtils.watch(
        //   () => view.zoom,
        //   (zoom) => {
        //     console.log(zoom);
        //   });

        let homeWidget = new Home({
          view: view
        });
        view.ui.add(homeWidget, "top-left");
        homeWidget.on("go", (event) => {
          edgesGL.removeAll();
          nodesGL.removeAll();
        });


        const legend = new Legend({
          view: view,
        });
        view.ui.add(legend, "bottom-right");

        // Add click event to parent features
        windFarmLayer = event.map.layers.find((layer) => layer.title.toLowerCase() === 'wind farms');
        windFarmLayer.outFields = ['*'];
        view.on("click", (event) => {
          view.hitTest(event, { include: [windFarmLayer, nodesGL] }).then((response) => {
            if (response.results && response.results.length > 0) {
              var graphic = response.results[0].graphic;
              // if graphic is node
              if (graphic.layer.id == 'nodesGL') {
                // let event = new CustomEvent('mapNodeClicked', { detail: graphic.attributes })
                // window.parent.document.dispatchEvent(event)
                const attributes = { from: 'windfarmmap', ...graphic.attributes };
                window.parent.postMessage(attributes, "*");
              }
              else {
                edgesGL.removeAll();
                nodesGL.removeAll();
                if (graphic && response.results[0].graphic.isAggregate) {
                  view.goTo({
                    center: [response.results[0].graphic.geometry.longitude, response.results[0].graphic.geometry.latitude],
                    zoom: view.zoom + 3
                  });
                }
                else if (graphic && graphic.attributes) {
                  showChildFeatures(JSON.parse(graphic.attributes.nodefeaturecollection));
                }
              }
            }
          });
        });
      });


      // Function to create a point graphic
      function createPointGraphic(feature, color) {
        return new Graphic({
          geometry: {
            type: "point",
            longitude: feature.geometry.coordinates[0],
            latitude: feature.geometry.coordinates[1]
          },
          attributes: feature.properties,
          symbol: {
            type: "simple-marker",
            color: color,
            size: "12px"
          },
          popupTemplate: {
            title: "Node - {Foundation}",
            content: [{
              type: "fields",
              fieldInfos: [{
                fieldName: "InstrumentationTag",
                label: "Instrumentation Tag"
              }, {
                fieldName: "NodeType",
                label: "Node Type"
              }, {
                fieldName: "Longitude",
                label: "Longitude"
              }
                , {
                fieldName: "Latitude",
                label: "Latitude"
              }]
            }]
          }
        });
      }
      // Function to show child features and connections
      function showChildFeatures(nodeFeatureCollection) {
        edgesGL.removeAll();
        nodesGL.removeAll();
        var children = nodeFeatureCollection.features;
        if (children) {
          children.forEach((feature) => {
            var childGraphic = createPointGraphic(feature, "red");
            nodesGL.add(childGraphic);

            // Create a line connecting parent and child
            for (let i = 0; i < feature.properties.linkTo.length; i++) {
              var line = new Polyline({
                paths: [
                  [feature.geometry.coordinates, feature.properties.linkTo[i].geometry.coordinates]
                ]
              });
              var lineGraphic = new Graphic({
                geometry: line,
                symbol: {
                  type: "simple-line",
                  color: "green",
                  width: 2
                }
              });
              edgesGL.graphics.add(lineGraphic);
            }
          });

          view.goTo(nodesGL.graphics);
          // then(function () {
          //   view.zoom = view.zoom - 1;
          // });
        }
      }
    });
  </script>
</body>

</html>
